现代电子技术Modern Electronics Technique2024年1月1日第47卷第1期Jan.  2024Vol. 47  No. 10  引  言司机在疲劳状态下驾驶汽车将极大增加发生交通事故的风险。统计显示，2020年全年中国交通事故发生数量为1 313 606起，事故造成61 703死亡，250 723人受伤，带来的经济损失[1]超过244 000万元人民币。由疲劳驾驶导致的交通事故数量占事故总量[2]的25%以上，事故死亡率达到83%。因此，出于对驾驶员及行人安全、社会和谐稳定、国家经济发展等一系列问题的考虑，准确有效的疲劳驾驶检测系统的研发已经成为当前交通安全领域的研究重点。当前针对疲劳驾驶的检测方法主要包含三类：基于司机生理参数的检测方法、基于车辆行为的检测方法和基于司机面部特征的检测方法[3]。基于司机生理参数的疲劳驾驶检测方法主要通过脑电、心电等信号对疲劳状态进行评价，此类方法对生汽车智能驾舱驾驶疲劳检测系统设计柏俊波1，2， 周涛琪2， 柏俊杰2（1.上海易咖智车科技有限公司， 上海 嘉定  201800； 2.重庆科技学院 电气工程学院， 重庆  400010）摘  要： 疲劳驾驶是影响交通安全的主要因素，当前疲劳驾驶的检测方法普遍存在设备体积大、侵入性强、实时性差等弊端。文中设计的基于FPGA的疲劳驾驶检测系统，首先利用区域长宽比改进YCbCr人脸分割算法，提高算法在驾驶环境中对于人脸的辨识度；然后建立动态视频人眼跟踪模型，在人脸范围内定位人眼位置，采用三帧差算法检测眨眼动作，以眨眼率作为疲劳的评价指标，对司机状态进行实时监控；最后利用FPGA芯片完成实时图像数据的处理和疲劳驾驶检测。实验证明，该系统具备在光线昏暗和佩戴眼镜等场景下检测疲劳状态的能力，并且检测系统充分发挥FPGA芯片数据并行处理优势，具备体积小、速度快、集成度高，通电即可工作的特点，有利于在狭小的驾驶舱环境部署，具有一定的工程应用价值。关键词： 疲劳驾驶检测； 人脸识别； 机器视觉； 眨眼率； 帧差法； FPGA中图分类号： TN911.73⁃34                           文献标识码： A                     文章编号： 1004⁃373X（2024）01⁃0147⁃06Design of driving fatigue detection system for intelligent cockpit of automobileBAI Junbo1, 2, ZHOU Taoqi2, BAI Junjie2(1. Shanghai Ecar Technology Co., Ltd., Shanghai 201800, China;2. School of Electrical Engineering, Chongqing University of Science and Technology, Chongqing 400010, China)Abstract： Fatigue driving is considered one of the main factors affecting traffic safety. The current detection methods for fatigue driving generally have drawbacks, such as large volume of detection equipment, strong invasiveness and poor real⁃time performance. The driving fatigue detection system designed in this article is based on FPGA. The face segmentation algorithm YCbCr is improved by the aspect ratio of the region, so as to improve the recognition of faces in the driving environment. Then, a human eye tracking model based on dynamic videos is established to locate the eyes within the range of faces. The three⁃frame difference algorithm is used for blink detection, and the blink rate is used as the evaluation index to monitor the driver's state in real time. The real⁃time image data processing and driving fatigue detection is completed with FPGA chips. The experiments have shown that the designed system can detect fatigue in dim light and when the drivers wear glasses. Moreover, the detection system can fully utilize the advantages of FPGA chip data parallel processing, and has the characteristics of small size, high speed, high integration and can work when powered on, so it is conducive to the deployment in narrow cockpit. Therefore, it has a certain engineering application value.Keywords： driving fatigue detection; face recognition; machine vision; blink rate; frame difference; FPGADOI：10.16652/j.issn.1004⁃373x.2024.01.026引用格式：柏俊波，周涛琪，柏俊杰.汽车智能驾舱驾驶疲劳检测系统设计[J].现代电子技术，2024，47（1）：147⁃152.收稿日期：2023⁃06⁃07           修回日期：2023⁃07⁃03基金项目：重庆市自然科学基金项目（cstc2020jcyj⁃msxmX0452）；教育部产学研创新基金（2020HYA06001）147147现代电子技术2024年第47卷理信号的分类效果较好，疲劳检测精度较高，但是信号采集和分析设备体积过大，需要司机全程佩戴，容易影响司机正常驾车行为[4⁃5]。为了克服基于生理参数的疲劳驾驶检测方法具有侵入性的问题，一部分学者通过车辆行为判断司机疲劳状态。此类方法通过方向盘数据、车道偏移量等特征对司机疲劳状态做出间接评价。基于车辆行为的疲劳驾驶检测方法对司机干扰较小，但不能直接反映司机的真实状态，检测精度不高，同时，此类方法具有滞后性，实时性不好[6⁃7]。相比于以上两类方法，基于司机面部特征的疲劳驾驶检测方法具备非接触、效果好等优势，通过相机实时采集司机面部特征，可以对司机状态进行直接的客观评价。传统的基于驾驶员面部特征的检测方法检测效果较好，但需要借助大量图像处理算法和机器学习算法，大量且复杂的算法会影响检测系统的实时性，导致大多数此类方法需要借助PC机才能完成疲劳状态的判断及预警，不利于在驾驶室环境大量部署和推广[8⁃10]。算法复杂、设备庞大制约着机器视觉算法在疲劳驾驶检测领域的发展，为了解决这一问题，部分学者尝试基于嵌入式设备实现司机状态的实时监测。文献[11]在汽车仪表盘内安装微型红外摄像机，将拍摄到的驾驶员面部特征利用包含FPGA的嵌入式设备进行处理，用以对驾驶员的精神状态进行评估，系统能够在720.576 ms的时间内处理16×7帧实时检测画面，检测效率大大提升。文献[12]基于FPGA平台，开发出基于Sobel边缘检测算子和差分法相结合的疲劳驾驶检测系统，系统通过识别人眼轮廓，计算眨眼频率对驾驶员疲劳状态进行检测，系统结构采用流水线设计，大幅提升了疲劳驾驶检测速度。综上所述，为了提高疲劳驾驶检测系统的集成度和实时性，同时面向狭小、复杂的驾驶环境，本文基于FPGA硬件平台，设计了一种通过司机眨眼频率判断其是否疲劳的检测方法，该方法具有响应速度快、检测精度高、体积小等特点，满足昏暗、颠簸等复杂情形下的检测要求。1  算法设计方案眨眼率常被作为评价司机疲劳驾驶的重要指标之一，因此，在复杂的驾驶环境正确计算司机眨眼频率是本文的研究重点。本文首先改进YCbCr人脸检测算法，提高人脸区域分割精确度；再在人脸范围之内跟踪司机双眼位置；最后利用帧差法检测眨眼动作并计算眨眼频率。算法设计流程如图1所示。1.1  人脸分割算法设计在FPGA平台上开发设计疲劳驾驶检测系统，首先要分割人脸区域，在人脸区域范围内进行眼部区域分割和眨眼动作检测可以减小系统计算量，节省开发板资源。本文首先采用区域长宽比改进YCbCr算法，框选出准确、完整的人脸后，提取每一帧图像中人脸框对应的4个像素点的像素坐标值，为人眼跟踪奠定基础。图1  算法设计流程图1.1.1  基于区域长宽比的YCbCr人脸区域分割算法YCbCr颜色空间将图像分解为亮度信息（Y）和色度信息（Cb、Cr），根据人体肤色的色度分布规律实现人脸分割[13]。不同年龄和性别人群，即使人种不同，其肤色的色度分量都会集中在特定范围之内，因此，只需要根据肤色的Cb、Cr分量值，而不用考虑背景和环境就能很好地分割人脸区域。此外，YCbCr算法逻辑简单，易于实现，能够提高FPGA芯片对图像的采样率，因此，本文探究基于YCbCr颜色空间的人脸区域分割算法，算法基本原理如式（1）所示：■■||||||■■||||||YCbCr=■■||||||■■||||||0.2570.5040.098-0.148-0.2910.4390.439-0.378-0.071■■||||||■■||||||RGB+■■||||||■■||||||0128128（1）式中将Y分量的常数置0可削弱图像亮度的影响。统计人体肤色Cb、Cr的分布规律后，将人脸的色度分量定义在式（2）和式（3）的范围内。90<Cb<135（2）120<Cr<170（3）YCbCr算法是对肤色区域的简单分割，当图像中出现非人脸肤色区域时，该算法会产生误检。为了提高系统检测精度，本文采用区域长宽比对YCbCr算法进行改148第1期进，改进的原理是计算检测出的肤色区域最大长宽比，将满足比例要求的区域判定为人脸区域，反之，则为非人脸区域。计算100张驾驶场景中人脸最大长宽比（Ratio）后，本文将人脸长宽比判定阈值设定为：1.20≤Ratio≤1.70（4）驾驶环境下司机面部画面相对稳定，通过公式（4）计算后可排除非人脸肤色区域的干扰，算法的优化过程如图2所示。图2  YCbCr算法优化过程1.1.2  人脸区域分割效果经过图2所示的处理后，人脸区域像素值为1，非人脸区域像素值为0，达到了人脸分割的目的。在此基础上，通过搜索画面中灰度为1的像素坐标点极值就可框选出人脸。优化后的YCbCr算法在实车环境下检测人脸区域的效果如图3所示。图3  优化后YCbCr算法人脸检测效果1.2  人眼跟踪算法设计当驾驶员头部保持静止时，只需要检测人脸肤色区域23以上范围的运动目标即可，但是实际驾驶场景中，驾驶员头部往往处于不停晃动的状态，因此，找到头部晃动状态下的人眼大概位置是算法改进的难点所在。驾驶员头部晃动时，双眼中心点的运动轨迹与头部的运动轨迹呈现一定规律性，只需要找到双眼中线点运动轨迹与头部位移之间的关系即可对人眼进行定位[14]。连续两帧图像人脸横、纵位移和人眼中心横、纵位移的计算如图4所示。图4中：Δxhk、Δyhk分别表示头部横向、纵向位移；Δxek、Δyek分别表示双眼中心点横向、纵向位移。统计99组Δxhk、Δxek以及Δyhk、Δyek数据并进行数据关系拟合，结果如图5所示。图4  头部位移和双眼中心点位移图5  人眼中心位移与头部位移的关系数据拟合后得到Δxhk、Δxek以及Δyhk、Δyek之间的关系如式（5）和式（6）所示：Δxe=1.22Δxh-1.33（5）Δye=0.94Δxh+0.15（6）式中：Δxe表示待测眼睛横向位移；Δye表示待测眼睛纵向位移；Δxh表示利用帧差法计算得到的相邻两帧图像的头部横向位移；Δyh表示利用帧差法计算得到的相邻两帧图像的头部纵向位移。通过式（5）和式（6）的运算，检测范围进一步压缩到人眼区域，过滤了肤色区域内的运动噪声，提高了检测精度。然而，眼睛周围的镜框、眉毛等微小变化会使图像出现空洞，因此，在对两张差分图像进行与操作时，还需要对图像进行腐蚀膨胀操作，去除图像中的尖锐空白点。柏俊波，等：汽车智能驾舱驾驶疲劳检测系统设计149现代电子技术2024年第47卷1.3  眨眼动作检测算法设计在人眼区域范围内通过帧差法检测运动目标的像素变化即可检测眨眼动作[15]。帧差法检测眨眼动作的优势在于：选取前一帧或前几帧图像作为标准背景图像，将当前帧图像与前一帧图像做差分运算可以解决标准背景图像实时更新和重建的难题。为了避免系统检测过灵敏，本文采用三帧差算法，算法原理如图6所示。图6  三帧差法流程假设第k-2、k-1、k张图片的图像函数分别为Fk-2(x,y)、Fk-1(x,y)、Fk(x,y)，则计算得到的差分图函数如式（7）和式（8）所示：Dk(x,y)=||Fk(x,y)-Fk-1(x,y)（7）Dk-1(x,y)=||Fk-1(x,y)-Fk-2(x,y)（8）式中：Dk(x,y)、Dk-1(x,y)分别为两张差分图像的图像函数，将两张差分图进行与运算后得到的运动目标图像函数如式（9）所示：A(x,y)=Dk(x,y)*Dk-1(x,y)（9）眨眼动作检测效果如图7所示，本文采用的眨眼动作检测算法将运动目标的检测区域集中在人眼周围，不统计非眨眼动作带来的像素变化，同时过滤了头发、眉毛等噪声干扰，提高检测精度的同时，降低了误检率。图7  眨眼动作检测1.4  基于眨眼率的疲劳驾驶状态检测标准华盛顿大学John A. Stren等人在其研究中指出，正常情况下，司机眨眼频率在12~17之间，随着驾驶时长增加和疲劳程度的增长，眨眼率[16]最高达到了每分钟40次。本文结合文献和台湾国立中央大学NTHU⁃DDD疲劳数据集实测数据，将眨眼频率fe与司机状态之间的关系用公式（10）表示：■■■||||||||fe∈[0,5),     睡眠fe∈[5,10)⋃[18,+∞),     疲劳fe∈[10,18),     正常（10）2  硬件设计方案系统硬件设计遵循从顶层到底层再到顶层的设计思路[17]：首先根据系统设计要求确定顶层设计方案，然后将顶层方案分解为PLL、ov5640_cfg、processor等多个功能子模块，各个子模块功能实现后联合调试运行，最终达到设计要求。2.1  顶层模块设计硬件部分主要包含摄像头配置和驱动模块、数据存储模块、疲劳驾驶检测模块以及VGA显示模块，PLL时钟模块产生4路时钟信号分别为各个功能模块供电。疲劳驾驶检测系统顶层设计如图8所示。图8  疲劳驾驶检测系统顶层模块设计150第1期各个功能模块描述如表1所示。表1  各个功能模块及其描述模块名称PLLov5640_cfgi2c_dricaptureprocessorsdram_topvga_driver功能产生4路时钟信号摄像头参数配置摄像头驱动获取相机图像信息图像处理、疲劳驾驶检测数据存储VGA显示驱动图8中：processor模块是本项目的核心模块，其主要功能是进行人脸分割、图像预处理、人眼跟踪、眨眼动作检测等。其中：YCbCr和pretreatment模块功能为图像预处理和人脸分割；binarization模块功能为图像二值化；Erosion和Dilation模块是图像形态学处理模块，主要功能是图像腐蚀和膨胀；Frame Difference为帧差模块，主要功能是检测眨眼动作。processor检测到眨眼动作后，发送img_current/post信号到数据存储驱动单元，完成眨眼次数的统计和眨眼的计算。2.2  基于FPGA的人脸区域分割模块设计由于capture输出图像为16位RGB565格式，而用于图像处理的输入图像为24位RGB888格式，因此，需要先将RGB565转化为RGB888。将公式（1）中每个分量前的小数系数乘以256，然后向右位移8位，完成乘法运算；然后将计算得到的数据进行相加，分别得到Y、Cb、Cr分量数值，完成图像由RGB888格式到YCbCr格式的转换。统计符合人体肤色的色度分量并计算区域长宽比Ratio1⋯Ration，将符合1.20≤Ratio≤1.70的肤色部分置1，其余部分置0，完成人脸区域分割。2.3  基于FPGA的眨眼动作检测和眨眼率统计模块设计对实时采集的图像在(Xmin,Ymin)、(Xmin,Ymax)、(Xmax,Ymin)范围内做差分运算，滤除非人脸的运动目标。基于FPGA的改进三帧差法眨眼动作检测流程如图9所示。图9  基于FPGA的改进三帧差法眨眼动作柏俊波，等：汽车智能驾舱驾驶疲劳检测系统设计基于FPGA的帧差眨眼动作检测主要步骤为：1） 将当前帧二值图像缓存一个时钟周期，选取人脸范围内有效部分，读取下一帧图像二值图，选取人脸有效部分；2） 利用式（5）和式（6）定位运动状态下的人眼区域；3） 将两帧二值图做差分运算，得到第一个差分图；4） 重复步骤1）和步骤2），得到第二张差分图；5） 将两张差分图进行与运算，最终判定是否有眨眼动作。3  疲劳状态检测实验本文以算法加速和提高检测系统集成度为目的，采用30 s为一个计数周期，对眨眼频率进行统计并判断司机是否存在疲劳风险。检测结果通过VGA驱动器实时打印到显示器输出，实现检测系统的可视化。3.1  疲劳状态检测实验如图10和图11所示，疲劳驾驶检测实验分为佩戴眼镜和不佩戴眼镜两种情形，系统实时统计30 s内的眨眼次数，将“正常”情况用白色字体进行显示，将“疲劳”和“睡眠”用白色斜体字突出显示。图10  不戴眼镜条件下的疲劳驾驶检测效果图11  佩戴眼镜条件下的疲劳驾驶检测效果图10a）在30 s内眨眼次数为0，显示数字为0，对应151现代电子技术2024年第47卷疲劳状态为“睡眠”；图10b）显示在30 s眨眼7次，对应眨眼频率为14次/min，检测状态为“正常”；图10c）显示30 s内眨眼13次，对应眨眼频率为26次/min，检测状态为“疲劳”。图11中为戴眼镜状态下的疲劳驾驶检测效果，可以看出，戴眼镜情况下依然能够准确检测疲劳状态。4  结  语本文采用硬件描述语言，通过Quartus Prime开发平台，在Cyclone Ⅳ FPGA芯片上完成算法的部署和疲劳驾驶状态的判断。硬件设计顶层模块包含了视频采集与存储、人脸区域分割、人眼位置跟踪、眨眼频率统计和疲劳驾驶判定多个功能子模块，充分发挥了FPGA优势，满足疲劳驾驶检测实时性要求。本文通过眨眼频率将疲劳状态分为正常、疲劳、睡眠三个等级进行预警。实验表明，系统对眨眼动作的检测灵敏度高，系统在不佩戴眼镜和佩戴眼镜两种场景下均可有效检测疲劳驾驶状态，满足疲劳驾驶预警的检测要求，可有效降低驾驶员疲劳驾驶风险。参考文献[1] 国家统计局.中国统计年鉴[EB/OL].[2022⁃09⁃12].https://www.stats.gov.cn/sj/ndsj/2022/indexch.htm.[2] 熊睿，邓院昌.疲劳驾驶交通事故的严重程度影响因素分析[J].中国安全生产科学技术，2022，18（4）：20⁃26.[3] 张瑞，朱天军，邹志亮，等.驾驶员疲劳驾驶检测方法研究综述[J].计算机工程与应用，2022，58（21）：53⁃66.[4] GAO Z K, WANG X M, YANG Y X, et al. EEG⁃based spatio⁃temporal convolutional neural network for driver fatigue evalua⁃tion [J]. IEEE transactions on neural networks and learning sys⁃tems, 2019, 30(9): 2755⁃2763.[5] TUNCER T, DOGAN S, ERTAM F, et al. A dynamic center and multi threshold point based stable feature extraction net⁃work for driver fatigue detection utilizing EEG signals [J]. Cog⁃nitive neurodynamics, 2021, 15(7): 223⁃237.[6] ZHANG H, WU C, HUANG Z, et al. Sensitivity of lane position and steering angle measurements to driver fatigue [J]. Transporta⁃tion research record, 2019, 2585(1): 67⁃76.[7] LI R, CHEN Y V, ZHANG L H. A method for fatigue detection based on Driver's steering wheel grip [J]. International journal of industrial ergonomics, 2021, 82(1): 103083.[8] DENG W H, WU R X. Real⁃time driver⁃drowsiness detection system using facial features [J]. IEEE access, 2019, 7: 118727⁃118738.[9] SAVAS B K, BECERIKLI Y. Real time driver fatigue detection system based on multi⁃task ConNN [J]. IEEE access, 2020, 8: 12491⁃12498.[10] LI X F, XIA J H, CAO L B, et al. Driver fatigue detection based on convolutional neural network and face alignment for edge computing device [J]. Proceedings of the institution of me⁃chanical engineers, part D: Journal of automobile engineering, 2021, 235(10/11): 2699⁃2711.[11] VITABILE S, DE PAOLA A, SORBELLO F. A real⁃time non⁃intrusive FPGA⁃based drowsiness detection system [J]. Journal of ambient intelligence and humanized computing, 2011, 2(4): 251⁃262.[12] 曹国震，彭寒，谭伟.基于FPGA的疲劳驾驶检测算法研究与设计[J].电子设计工程，2016，24（12）：165⁃167.[13] 崔鹏，燕天天.融合YCbCr肤色模型与改进的Adaboost算法的人脸检测[J].哈尔滨理工大学学报，2018，23（2）：91⁃96.[14] 梁万元，种银保，赵安，等.基于YCbCr颜色空间相邻帧差建模的眼睛定位算法研究[J].中国医学装备，2014，11（10）：40⁃43.[15] 黄名政，李彬华.动态帧差法及其FPGA设计与实现[J].光学技术，2023，49（2）：231⁃237.[16] STERN J A, BOYER D, SCHROEDER D. Blink rate: A pos⁃sible measure of fatigue [J]. Human factors, 1994, 36(2): 285⁃297.[17] 毛志林.FPGA硬件系统的设计流程分析[J].电子技术，2022，51（11）：4⁃5.作者简介：柏俊波（1978—），男，湖北襄阳人，硕士，高级工程师，研究方向为图像处理、自动驾驶。周涛琪（1996—），男，重庆忠县人，硕士，研究方向为机器视觉、嵌入式设计。柏俊杰（1976—），男，湖北襄阳人，博士，教授，研究方向为机器视觉、智能机器人。152